<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VitroCanvas Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <header class="sticky top-0 z-10 border-b border-white/10 bg-neutral-950/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="font-semibold tracking-wide">VitroCanvas Admin</div>
      <div class="text-xs text-neutral-400">/admin</div>
      <div class="ml-auto flex gap-2">
        <button id="btn-reload" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15">Ανανέωση</button>
        <button id="btn-save" class="px-3 py-2 rounded-lg bg-amber-500 text-black hover:bg-amber-400 font-semibold">Αποθήκευση</button>
        <button id="btn-logout" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15">Αποσύνδεση</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div id="status" class="mb-4 text-sm text-neutral-300"></div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 rounded-2xl border border-white/10 bg-white/5 p-5">
        <h2 class="text-lg font-semibold mb-3">Προϊόντα</h2>
        <div class="flex gap-2 mb-3">
          <button id="btn-add-product" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15">+ Προσθήκη</button>
          <div class="ml-auto text-xs text-neutral-400">Tip: ανέβασε εικόνα και βάλε το URL στο πεδίο “image”.</div>
        </div>
        <div class="overflow-auto border border-white/10 rounded-xl">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-neutral-300">
              <tr>
                <th class="text-left p-3">Όνομα</th>
                <th class="text-left p-3">Τιμή</th>
                <th class="text-left p-3">Κατηγ.</th>
                <th class="text-left p-3">Stock</th>
                <th class="text-left p-3">Εικόνα</th>
                <th class="text-left p-3">—</th>
              </tr>
            </thead>
            <tbody id="products-tbody"></tbody>
          </table>
        </div>
      </section>

      <section class="rounded-2xl border border-white/10 bg-white/5 p-5">
        <h2 class="text-lg font-semibold mb-3">Ρυθμίσεις</h2>

        <div class="space-y-4">
          <label class="flex items-center gap-3">
            <input id="maintenance" type="checkbox" class="h-4 w-4" />
            <span>Maintenance mode (για το public)</span>
          </label>

          <div class="border border-white/10 rounded-xl p-4 bg-black/20">
            <div class="text-sm font-semibold mb-2">Χρώματα / Effects</div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <label class="block">primary
                <input id="gfx-primary" class="mt-1 w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2" placeholder="#fbc02d">
              </label>
              <label class="block">opacity
                <input id="gfx-opacity" class="mt-1 w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2" placeholder="0.6">
              </label>
              <label class="block">glowStart
                <input id="gfx-glowStart" class="mt-1 w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2" placeholder="#fbc02d">
              </label>
              <label class="block">glowEnd
                <input id="gfx-glowEnd" class="mt-1 w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2" placeholder="#b71c1c">
              </label>
              <label class="block">spinSpeed
                <input id="gfx-spinSpeed" class="mt-1 w-full rounded-lg bg-black/30 border border-white/10 px-3 py-2" placeholder="60">
              </label>
            </div>
          </div>

          <div class="border border-white/10 rounded-xl p-4 bg-black/20">
            <div class="text-sm font-semibold mb-2">Upload εικόνας</div>
            <div class="flex items-center gap-2">
              <input id="upload-file" type="file" accept="image/*" class="text-sm" />
              <button id="btn-upload" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15">Ανέβασμα</button>
            </div>
            <div class="text-xs text-neutral-400 mt-2">Θα πάρεις URL τύπου /uploads/.... και το βάζεις σε image / staticImages.</div>
            <pre id="upload-result" class="mt-2 text-xs whitespace-pre-wrap text-neutral-300"></pre>
          </div>

          <div class="border border-white/10 rounded-xl p-4 bg-black/20">
            <div class="text-sm font-semibold mb-2">staticImages (key → url)</div>
            <textarea id="staticImages" class="w-full h-44 rounded-lg bg-black/30 border border-white/10 px-3 py-2 text-sm" placeholder='{"img-service-1":"/uploads/..."}'></textarea>
          </div>
        </div>
      </section>
    </div>

    <section class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-5">
      <h2 class="text-lg font-semibold mb-3">Blog</h2>
      <div class="flex gap-2 mb-3">
        <button id="btn-add-post" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15">+ Προσθήκη</button>
      </div>
      <div id="posts" class="space-y-3"></div>
    </section>
  </main>

<script>
let siteData = null;

const $ = (id) => document.getElementById(id);

function setStatus(msg, ok=true) {
  const el = $('status');
  el.textContent = msg;
  el.className = "mb-4 text-sm " + (ok ? "text-emerald-300" : "text-rose-300");
}

async function apiJSON(url, opts={}) {
  const r = await fetch(url, { cache: 'no-store', credentials: 'include', ...opts });
  const txt = await r.text();
  let j = null;
  try { j = JSON.parse(txt); } catch {}
  if (!r.ok) {
    const msg = (j && (j.error || j.message)) ? (j.error || j.message) : txt || ("HTTP " + r.status);
    throw new Error(msg);
  }
  return j ?? {};
}

function ensureShape(d) {
  return {
    products: Array.isArray(d?.products) ? d.products : [],
    blogPosts: Array.isArray(d?.blogPosts) ? d.blogPosts : [],
    staticImages: (d?.staticImages && typeof d.staticImages === 'object') ? d.staticImages : {},
    globalTexts: (d?.globalTexts && typeof d.globalTexts === 'object') ? d.globalTexts : {},
    globalGraphics: (d?.globalGraphics && typeof d.globalGraphics === 'object') ? d.globalGraphics : { primary:"#fbc02d", opacity:"0.6", glowStart:"#fbc02d", glowEnd:"#b71c1c", spinSpeed:"60" },
    analytics: (d?.analytics && typeof d.analytics === 'object') ? d.analytics : { totalVisits:0, pageViews:{} },
    isMaintenance: Boolean(d?.isMaintenance),
  };
}

function renderProducts() {
  const tbody = $('products-tbody');
  tbody.innerHTML = "";
  siteData.products.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.className = "border-t border-white/10";
    tr.innerHTML = \`
      <td class="p-3 align-top">
        <input class="w-full rounded bg-black/30 border border-white/10 px-2 py-1" value="\${escapeHtml(p.name ?? '')}" data-k="name" data-i="\${idx}">
        <textarea class="mt-2 w-full h-16 rounded bg-black/30 border border-white/10 px-2 py-1 text-xs" placeholder="desc" data-k="desc" data-i="\${idx}">\${escapeHtml(p.desc ?? '')}</textarea>
        <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
          <label class="block">discount
            <input class="w-full rounded bg-black/30 border border-white/10 px-2 py-1" value="\${escapeHtml(String(p.discount ?? 0))}" data-k="discount" data-i="\${idx}">
          </label>
          <label class="block">id
            <input class="w-full rounded bg-black/30 border border-white/10 px-2 py-1" value="\${escapeHtml(String(p.id ?? ''))}" data-k="id" data-i="\${idx}">
          </label>
        </div>
      </td>
      <td class="p-3 align-top">
        <input class="w-28 rounded bg-black/30 border border-white/10 px-2 py-1" value="\${escapeHtml(String(p.price ?? ''))}" data-k="price" data-i="\${idx}">
      </td>
      <td class="p-3 align-top">
        <input class="w-40 rounded bg-black/30 border border-white/10 px-2 py-1" value="\${escapeHtml(String(p.category ?? ''))}" data-k="category" data-i="\${idx}">
      </td>
      <td class="p-3 align-top">
        <select class="w-36 rounded bg-black/30 border border-white/10 px-2 py-1" data-k="stock" data-i="\${idx}">
          \${option(p.stock, "in-stock", "in-stock")}
          \${option(p.stock, "sold", "sold")}
          \${option(p.stock, "made-to-order", "made-to-order")}
        </select>
      </td>
      <td class="p-3 align-top">
        <input class="w-80 rounded bg-black/30 border border-white/10 px-2 py-1" value="\${escapeHtml(String(p.image ?? ''))}" data-k="image" data-i="\${idx}">
      </td>
      <td class="p-3 align-top">
        <button class="px-2 py-1 rounded bg-white/10 hover:bg-white/15" data-act="up" data-i="\${idx}">↑</button>
        <button class="px-2 py-1 rounded bg-white/10 hover:bg-white/15" data-act="down" data-i="\${idx}">↓</button>
        <button class="px-2 py-1 rounded bg-rose-500/80 hover:bg-rose-500" data-act="del" data-i="\${idx}">Διαγραφή</button>
      </td>
    \`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('input, textarea, select').forEach(el => {
    el.addEventListener('change', () => {
      const i = Number(el.dataset.i);
      const k = el.dataset.k;
      let v = el.value;
      if (k === 'discount') v = Number(v || 0);
      if (k === 'id') v = isNaN(Number(v)) ? v : Number(v);
      siteData.products[i][k] = v;
    });
  });

  tbody.querySelectorAll('button[data-act]').forEach(btn => {
    btn.addEventListener('click', () => {
      const i = Number(btn.dataset.i);
      const act = btn.dataset.act;
      if (act === 'del') {
        siteData.products.splice(i,1);
      } else if (act === 'up' && i > 0) {
        const t = siteData.products[i-1]; siteData.products[i-1] = siteData.products[i]; siteData.products[i] = t;
      } else if (act === 'down' && i < siteData.products.length-1) {
        const t = siteData.products[i+1]; siteData.products[i+1] = siteData.products[i]; siteData.products[i] = t;
      }
      renderProducts();
    });
  });
}

function option(current, value, label) {
  const sel = (String(current||"") === value) ? "selected" : "";
  return \`<option value="\${value}" \${sel}>\${label}</option>\`;
}

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
  }[c]));
}

function renderPosts() {
  const wrap = $('posts');
  wrap.innerHTML = "";
  siteData.blogPosts.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = "rounded-2xl border border-white/10 bg-black/20 p-4";
    card.innerHTML = \`
      <div class="flex items-center gap-2">
        <input class="flex-1 rounded bg-black/30 border border-white/10 px-2 py-1" placeholder="title" value="\${escapeHtml(p.title ?? '')}" data-k="title" data-i="\${idx}">
        <button class="px-2 py-1 rounded bg-rose-500/80 hover:bg-rose-500" data-act="del" data-i="\${idx}">Διαγραφή</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2 text-sm">
        <input class="rounded bg-black/30 border border-white/10 px-2 py-1" placeholder="date" value="\${escapeHtml(p.date ?? '')}" data-k="date" data-i="\${idx}">
        <input class="md:col-span-2 rounded bg-black/30 border border-white/10 px-2 py-1" placeholder="image url" value="\${escapeHtml(p.image ?? '')}" data-k="image" data-i="\${idx}">
      </div>
      <textarea class="mt-2 w-full h-40 rounded bg-black/30 border border-white/10 px-2 py-2 text-sm" placeholder="content (HTML allowed)" data-k="content" data-i="\${idx}">\${escapeHtml(p.content ?? '')}</textarea>
    \`;
    wrap.appendChild(card);
  });

  wrap.querySelectorAll('input, textarea').forEach(el => {
    el.addEventListener('change', () => {
      const i = Number(el.dataset.i);
      const k = el.dataset.k;
      siteData.blogPosts[i][k] = el.value;
    });
  });

  wrap.querySelectorAll('button[data-act="del"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const i = Number(btn.dataset.i);
      siteData.blogPosts.splice(i,1);
      renderPosts();
    });
  });
}

async function load() {
  setStatus("Φορτώνω δεδομένα…");
  const j = await apiJSON('/api/site');
  siteData = ensureShape(j.data || {});
  $('maintenance').checked = !!siteData.isMaintenance;

  // graphics
  $('gfx-primary').value = siteData.globalGraphics.primary || "";
  $('gfx-opacity').value = siteData.globalGraphics.opacity || "";
  $('gfx-glowStart').value = siteData.globalGraphics.glowStart || "";
  $('gfx-glowEnd').value = siteData.globalGraphics.glowEnd || "";
  $('gfx-spinSpeed').value = siteData.globalGraphics.spinSpeed || "";

  $('staticImages').value = JSON.stringify(siteData.staticImages || {}, null, 2);

  renderProducts();
  renderPosts();
  setStatus("Έτοιμο ✅");
}

function syncSettingsIntoData() {
  siteData.isMaintenance = $('maintenance').checked;

  siteData.globalGraphics = siteData.globalGraphics || {};
  siteData.globalGraphics.primary = $('gfx-primary').value || siteData.globalGraphics.primary || "#fbc02d";
  siteData.globalGraphics.opacity = $('gfx-opacity').value || siteData.globalGraphics.opacity || "0.6";
  siteData.globalGraphics.glowStart = $('gfx-glowStart').value || siteData.globalGraphics.glowStart || "#fbc02d";
  siteData.globalGraphics.glowEnd = $('gfx-glowEnd').value || siteData.globalGraphics.glowEnd || "#b71c1c";
  siteData.globalGraphics.spinSpeed = $('gfx-spinSpeed').value || siteData.globalGraphics.spinSpeed || "60";

  // staticImages
  try {
    const obj = JSON.parse($('staticImages').value || "{}");
    if (obj && typeof obj === 'object') siteData.staticImages = obj;
  } catch (e) {
    throw new Error("Το staticImages δεν είναι σωστό JSON.");
  }
}

async function save() {
  try {
    syncSettingsIntoData();
    setStatus("Αποθηκεύω…");
    const j = await apiJSON('/api/site', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: siteData }),
    });
    siteData = ensureShape(j.data || siteData);
    setStatus("Αποθηκεύτηκε ✅");
  } catch (e) {
    setStatus("Σφάλμα: " + (e.message || e), false);
  }
}

async function logout() {
  try { await apiJSON('/api/logout', { method: 'POST' }); } catch {}
  window.location.href = '/';
}

async function upload() {
  const f = $('upload-file').files[0];
  if (!f) return setStatus("Διάλεξε πρώτα αρχείο.", false);
  setStatus("Ανεβάζω εικόνα…");
  const fd = new FormData();
  fd.append('file', f);
  const r = await fetch('/api/upload', { method: 'POST', credentials:'include', body: fd });
  const txt = await r.text();
  if (!r.ok) return setStatus("Upload error: " + txt, false);
  let j = {};
  try { j = JSON.parse(txt); } catch {}
  $('upload-result').textContent = txt;
  if (j && j.url) setStatus("Upload OK ✅  URL: " + j.url);
  else setStatus("Upload έγινε αλλά δεν πήρα URL.", false);
}

$('btn-reload').addEventListener('click', () => load().catch(e => setStatus("Σφάλμα: " + e.message, false)));
$('btn-save').addEventListener('click', () => save());
$('btn-logout').addEventListener('click', () => logout());
$('btn-upload').addEventListener('click', () => upload());
$('btn-add-product').addEventListener('click', () => {
  siteData.products.unshift({ id: Date.now(), name:"", price:"", discount:0, category:"stained-glass", stock:"in-stock", image:"", desc:"" });
  renderProducts();
});
$('btn-add-post').addEventListener('click', () => {
  siteData.blogPosts.unshift({ id: Date.now(), title:"", date:"", image:"", content:"<p></p>" });
  renderPosts();
});

load().catch(e => setStatus("Σφάλμα φόρτωσης: " + e.message, false));
</script>
</body>
</html>
